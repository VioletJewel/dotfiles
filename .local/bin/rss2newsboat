#!/usr/bin/dash

notif(){ xset -q >/dev/null 2>&1 && hash notify-send >/dev/null 2>&1 && notify-send "$1"; }
err(){
  tty -s &&
    1>&2 echo "$2" || notif "$0: $2"
  exit "$1";
}

hash xsel && hash grep && hash curl && hash awk hash notify-send ||
  err 1 'Fatal: install required programs: xsel, grep, curl, awk, notify-send';

(
  url="$(xsel -bo)";
  cat ~/.newsboat/urls 2>/dev/null;
  case "$url" in

  'https://www.youtube.com/@'*) # yt channel page => RSS for channel
    printf '%s "yt" "~YouTube @%s"\n' \
      "$(curl -s "$url" | grep -oi 'https://www\.youtube\.com/feeds/videos\.xml?channel_id=[^"/?]\+' | head -n1)" \
      "$(echo -n "$url" | sed -e 's/https:\/\/www\.youtube\.com\/@//')" ||
        err 2 "Fatal: '$url' doesn't seem to have any RSS feeds";
    break;;

  'https://www.youtube.com/'*) # yt video => RSS for channel
    printf 'https://www.youtube.com/feeds/videos.xml?channel_id=%s "yt" "~YouTube %s"\n' \
      $(curl -s "$url" | grep -Poi '(?<=.channelId":")[^"]+|(?<=url":"/)@[^"/?]+' | awk '!a[$0]++' | head -n2) ||
        err 2 "Fatal '$url' doesn't seem to have any RSS feeds";
    break;;

  'https://mastodon.social/@'*) # mastadon user/post => RSS for user
    printf '%s.rss\n' "$(echo -n "$url" | sed 's/\(@[^/?.]\+\).*/\1/')";
    break;;

  *'/feed'*|*'/rss'*|*'.rss'*) # /feed /rss .rss => RSS
    echo "$url";
    break;;

  'http://'*|'https://'*) # other URL => scrape HTML for all RSS feeds
    curl -s "$url" |
      grep -oP "(?<=href=['\"])https?://[^'\"]+(\\.rss\b|/rss\b|/feeds\?\b)[^'\"]*(?=['\"])" ||
      err 2 "Fatal: '$url' doesn't seem to have any RSS feeds";
    break;;

  *)
    err 3 "Fatal: '$url' doesn't look like a URL";

  esac;
) | awk '!a[$0]++' >/tmp/.newsboat.urls;

mv /tmp/.newsboat.urls ~/.newsboat/urls 2>/dev/null;

tty -s && echo 'done.' || notif 'done.';
